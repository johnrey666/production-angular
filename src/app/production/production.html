  <div class="production">
    <!-- Header -->
    <div class="page-header">
      <div>
        <h1>Daily Production Record</h1>
        <p>Select date to view or edit production data</p>
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
        <button class="btn-primary" (click)="saveAllProduction()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save Production
        </button>
        
        <button class="btn-secondary" (click)="exportToExcel()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Export Excel
        </button>
        
        <div class="date-selector">
          <div class="calendar-widget">
            <div class="calendar-input" (click)="toggleCalendar()">
              <span>{{ formatDate(selectedDate) }}</span>
              <svg class="calendar-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            
            <!-- Calendar Dropdown (Header) -->
            <div class="calendar-dropdown" *ngIf="showCalendar">
              <div class="calendar-header">
                <button class="calendar-nav-btn" (click)="prevMonth(); $event.stopPropagation()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <div class="calendar-month-year">
                  <span class="calendar-month">{{ getMonthName(currentMonth) }}</span>
                  <span class="calendar-year">{{ currentYear }}</span>
                </div>
                <button class="calendar-nav-btn" (click)="nextMonth(); $event.stopPropagation()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
              </div>
              
              <div class="calendar-weekdays">
                <div class="weekday">S</div>
                <div class="weekday">M</div>
                <div class="weekday">T</div>
                <div class="weekday">W</div>
                <div class="weekday">T</div>
                <div class="weekday">F</div>
                <div class="weekday">S</div>
              </div>
              
              <div class="calendar-days">
  <div *ngFor="let day of calendarDays" 
      class="day"
      [class.empty]="day === 0"
      [class.today]="isToday(day)"
      [class.selected]="isSelected(day)"
      (click)="selectDate(day); $event.stopPropagation()">
    {{ day === 0 ? '' : day }}
  </div>
              </div>
              
              <div class="calendar-quick-actions">
                <button class="quick-action-btn" (click)="selectToday(); $event.stopPropagation()">Today</button>
                <button class="quick-action-btn" (click)="selectYesterday(); $event.stopPropagation()">Yesterday</button>
                <button class="quick-action-btn" (click)="selectLastWeek(); $event.stopPropagation()">Last Week</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Snackbar -->
    <div class="snackbar-container" *ngIf="snackbarMessage">
      <div class="snackbar" [class]="'snackbar-' + snackbarType">
        <div class="snackbar-content">
          <div class="snackbar-icon">
            <svg *ngIf="snackbarType === 'success'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <svg *ngIf="snackbarType === 'error'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <svg *ngIf="snackbarType === 'warning'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </div>
          <div class="snackbar-message">{{ snackbarMessage }}</div>
        </div>
        <button class="snackbar-close" (click)="hideSnackbar()">X</button>
      </div>
    </div>

    <!-- Loading & Error States -->
    <div *ngIf="isLoading" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading production data for {{ selectedDate }}...</p>
    </div>

    <div *ngIf="errorMessage && !isLoading" class="error-state">
      <p>{{ errorMessage }}</p>
      <button class="btn-secondary" (click)="loadData()">Retry</button>
    </div>

    <!-- Main Content -->
    <div *ngIf="!isLoading && !errorMessage">
      <div class="search-bar">
        <div class="search-container">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input type="text" class="form-input search-input" placeholder="Search recipes or SKUs..."
                [(ngModel)]="searchQuery" (input)="onSearch()" style="padding-left: 36px;">
        </div>
        <div class="item-count-badge">
          {{ filteredEntries.length }} recipe{{ filteredEntries.length !== 1 ? 's' : '' }}
          <span *ngIf="isDataLoadedFromStorage" class="unsaved-badge">(Unsaved)</span>
        </div>
      </div>

      <!-- Production Cards -->
      <div class="production-entries">
        <div *ngFor="let entry of paginated" class="production-card">
          
          <!-- Recipe Header (collapsible) -->
          <div class="recipe-header" (click)="toggleRecipe(entry)">
            <div class="recipe-header-left">
              <button class="collapse-btn" [class.collapsed]="!entry.isExpanded">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <div class="recipe-info">
                <h3 class="recipe-name">{{ entry.recipe.name }}</h3>
                <div class="recipe-stats">
                  <span class="stat-badge">{{ getTotalSkus(entry) }} SKU{{ getTotalSkus(entry) !== 1 ? 's' : '' }}</span>
                  <span class="stat-badge">{{ entry.recipe.std_yield || 0 }}  STD</span>
                </div>
              </div>
            </div>
            <div class="order-section" (click)="$event.stopPropagation()">
              <div class="order-input-group">
                <label for="order-{{entry.recipe.id}}">Order (batch):</label>
                <input 
                  type="number" 
                  id="order-{{entry.recipe.id}}"
                  [(ngModel)]="entry.orderKg" 
                  (input)="recalculate(entry)"
                  (click)="$event.stopPropagation()"
                  step="0.1" 
                  min="0" 
                  class="order-input"
                  placeholder="0.0">
              </div>
            </div>
          </div>

          <!-- Collapsible Content -->
          <div class="collapsible-content" [class.expanded]="entry.isExpanded">
            <!-- Combined SKUs & Premixes Table -->
            <div class="table-wrapper" *ngIf="getAllItems(entry).length > 0">
              <div class="table-container">
                <table class="compact-table">
                  <thead>
                    <tr>
                      <th style="width: 200px;">SKU / Raw Material</th>
                      <th style="width: 70px;" class="text-right">1B</th>
                      <th style="width: 70px;" class="text-right">½B</th>
                      <th style="width: 70px;" class="text-right">¼B</th>
                      <th style="width: 100px;" class="text-right">ACTUAL RAW MAT</th>
                      <th style="width: 100px;">ACTUAL OUTPUT</th>
                      <th style="width: 90px;">VARIANCE</th>
                      <th style="width: 110px;">RAW MAT COST</th>
                      <th style="width: 150px;">REMARK</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- SKUs -->
                    <tr *ngFor="let sku of entry.recipe.skus" class="table-row">
                      <td>
                        <div class="item-info">
                          <div class="item-name">{{ sku.name }}</div>
                          <div class="item-type type-sku">SKU</div>
                        </div>
                      </td>
                      <td class="text-right number">{{ sku.quantity1b | number:'1.3-3' }}</td>
                      <td class="text-right number">{{ sku.quantityhalfb | number:'1.3-3' }}</td>
                      <td class="text-right number">{{ sku.quantityquarterb | number:'1.3-3' }}</td>
                      <td class="text-right actual-raw-mat">
                        {{ calculateActualRawMat(entry.orderKg, sku.quantity1b) | number:'1.3-3' }}
                      </td>
                      <td>
                        <input type="number" 
                              [(ngModel)]="sku.actualOutput"
                              (input)="onItemChange(entry)"
                              step="0.001" 
                              min="0" 
                              class="table-input text-center"
                              style="width: 90px;">
                      </td>
                      <td>
                        <input type="number" 
                              [(ngModel)]="sku.variance"
                              (input)="onItemChange(entry)"
                              step="0.001" 
                              class="table-input text-center"
                              style="width: 80px;">
                      </td>
                      <td>
                        <input type="number" 
                              [(ngModel)]="sku.rawMatCost"
                              (input)="onItemChange(entry)"
                              step="0.01" 
                              min="0" 
                              class="table-input text-center"
                              style="width: 100px;"
                              placeholder="₱">
                      </td>
                      <td>
                        <input type="text" 
                              [(ngModel)]="sku.remark"
                              (input)="onItemChange(entry)"
                              class="table-input"
                              style="width: 140px;"
                              placeholder="Notes...">
                      </td>
                    </tr>
                    
                    <!-- Premixes -->
                    <tr *ngFor="let premix of entry.recipe.premixes" class="table-row">
                      <td>
                        <div class="item-info">
                          <div class="item-name">{{ premix.name }}</div>
                          <div class="item-type type-premix">PRE-MIX</div>
                        </div>
                      </td>
                      <td class="text-right number">{{ premix.quantity1b | number:'1.3-3' }}</td>
                      <td class="text-right number">{{ premix.quantityhalfb | number:'1.3-3' }}</td>
                      <td class="text-right number">{{ premix.quantityquarterb | number:'1.3-3' }}</td>
                      <td class="text-right actual-raw-mat">
                        {{ calculateActualRawMat(entry.orderKg, premix.quantity1b) | number:'1.3-3' }}
                      </td>
                      <td>
                        <input type="number" 
                              [(ngModel)]="premix.actualOutput"
                              (input)="onItemChange(entry)"
                              step="0.001" 
                              min="0" 
                              class="table-input text-center"
                              style="width: 90px;">
                      </td>
                      <td>
                        <input type="number" 
                              [(ngModel)]="premix.variance"
                              (input)="onItemChange(entry)"
                              step="0.001" 
                              class="table-input text-center"
                              style="width: 80px;">
                      </td>
                      <td>
                        <input type="number" 
                              [(ngModel)]="premix.rawMatCost"
                              (input)="onItemChange(entry)"
                              step="0.01" 
                              min="0" 
                              class="table-input text-center"
                              style="width: 100px;"
                              placeholder="₱">
                      </td>
                      <td>
                        <input type="text" 
                              [(ngModel)]="premix.remark"
                              (input)="onItemChange(entry)"
                              class="table-input"
                              style="width: 140px;"
                              placeholder="Notes...">
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- No Items Message -->
            <div *ngIf="getAllItems(entry).length === 0" class="empty-items">
              <p>No SKUs defined for this recipe.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination" *ngIf="filteredEntries.length > 0">
        <div class="pagination-info">
          Showing {{ ((currentPage - 1) * itemsPerPage) + 1 }}–{{ (currentPage * itemsPerPage > filteredEntries.length ? filteredEntries.length : currentPage * itemsPerPage) }} of {{ filteredEntries.length }} recipe{{ filteredEntries.length !== 1 ? 's' : '' }}
        </div>
        <div class="pagination-controls">
          <button class="pagination-btn" (click)="prevPage()" [disabled]="currentPage === 1">
            Previous
          </button>
          <div class="page-numbers">
            <span class="current-page">{{ currentPage }}</span> of <span class="total-pages">{{ totalPages }}</span>
          </div>
          <button class="pagination-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next
          </button>
        </div>
      </div>

      <!-- Summary -->
      <div class="summary-bar" *ngIf="filteredEntries.length > 0">
        <div class="summary-item">
          <span class="summary-label">Production Date:</span>
          <span class="summary-value">{{ selectedDate }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Order:</span>
          <span class="summary-value">{{ getTotalOrder() | number:'1.1-2' }} batch</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Raw Mat:</span>
          <span class="summary-value">{{ getTotalActualRawMat() | number:'1.1-2' }} batch</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Cost:</span>
          <span class="summary-value">₱ {{ getTotalRawMatCost() | number:'1.0-0' }}</span>
        </div>
        <div class="summary-item" *ngIf="isDataLoadedFromStorage">
          <span class="summary-label unsaved-label">* Unsaved changes</span>
        </div>
      </div>

      <!-- No Data for Selected Date -->
      <div *ngIf="filteredEntries.length === 0 && !isLoading" class="empty-state">
        <div style="font-size: 64px; margin-bottom: 1rem;">Calendar</div>
        <h3 style="font-size: 18px; margin: 0.5rem 0;">No production data for {{ selectedDate }}</h3>
        <p style="color:#666; font-size: 16px;">Enter order quantities to start recording production</p>
      </div>
    </div>

    <!-- Save Modal -->
    <div *ngIf="showSaveModal" class="modal-overlay" (click)="closeSaveModal(); showCalendar = false">
      <div class="modal-container" (click)="$event.stopPropagation()" style="max-width: 500px;">
        <div class="modal-header">
          <h2 class="modal-title">Save Production Data</h2>
          <button class="modal-close" (click)="closeSaveModal()">X</button>
        </div>
        <div class="modal-body">
          <p>Save production data for <strong>{{ formatDate(selectedDate) }}</strong>?</p>

          <!-- Custom Calendar in Modal - Replaces input type="date" -->
          <div class="form-group">
            <label>Production Date</label>
            <div class="calendar-widget modal-calendar">
              <div class="calendar-input" (click)="toggleCalendar(); $event.stopPropagation()">
                <span>{{ formatDate(selectedDate) }}</span>
                <svg class="calendar-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>

              <div class="calendar-dropdown" *ngIf="showCalendar">
                <div class="calendar-header">
                  <button class="calendar-nav-btn" (click)="prevMonth(); $event.stopPropagation()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                  </button>
                  <div class="calendar-month-year">
                    <span class="calendar-month">{{ getMonthName(currentMonth) }}</span>
                    <span class="calendar-year">{{ currentYear }}</span>
                  </div>
                  <button class="calendar-nav-btn" (click)="nextMonth(); $event.stopPropagation()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </button>
                </div>

                <div class="calendar-weekdays">
                  <div class="weekday">S</div><div class="weekday">M</div><div class="weekday">T</div>
                  <div class="weekday">W</div><div class="weekday">T</div><div class="weekday">F</div><div class="weekday">S</div>
                </div>

                <div class="calendar-days">
  <div *ngFor="let day of calendarDays" 
      class="day"
      [class.empty]="day === 0"
      [class.today]="isToday(day)"
      [class.selected]="isSelected(day)"
      (click)="selectDate(day); $event.stopPropagation()">
    {{ day === 0 ? '' : day }}
  </div>
                </div>

                <div class="calendar-quick-actions">
                  <button class="quick-action-btn" (click)="selectToday(); onManualDateChange(); $event.stopPropagation()">Today</button>
                  <button class="quick-action-btn" (click)="selectYesterday(); onManualDateChange(); $event.stopPropagation()">Yesterday</button>
                  <button class="quick-action-btn" (click)="selectLastWeek(); onManualDateChange(); $event.stopPropagation()">Last Week</button>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Batch Name (Optional)</label>
            <input type="text" [(ngModel)]="batchName" class="form-input" placeholder="e.g., Morning Shift">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closeSaveModal()">Cancel</button>
          <button type="button" class="btn-primary" (click)="confirmSave()">Save Production</button>
        </div>
      </div>
    </div>
  </div>