<div class="dashboard" @fadeInUp>
  <!-- Loading State - CLEAN & CENTERED -->
  <div *ngIf="isLoading" class="dashboard-loading">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p class="loading-text">{{ loadingMessage }}</p>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-content" [class.content-loading]="isLoading">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="header-left">
        <h1 class="dashboard-title">Production Dashboard</h1>
        <div class="date-info">
          <span class="current-date">{{ currentDate }}</span>
          <span class="separator">•</span>
          <span class="period">{{ currentMonthYear }}</span>
        </div>
      </div>
      <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
        <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6"></path>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        <span>{{ isLoading ? 'Refreshing...' : 'Refresh' }}</span>
      </button>
    </header>

    <!-- Summary Stats -->
    <div class="stats-container">
      <div class="stat-item" [class]="getFillRateClass(allStoresFillRate)">
        <div class="stat-value">{{ allStoresFillRate }}%</div>
        <div class="stat-label">Fill Rate</div>
        <div class="stat-trend">
          {{ fillRateTrend > 0 ? '↑' : fillRateTrend < 0 ? '↓' : '→' }}
          {{ fillRateTrend > 0 ? '+' : '' }}{{ fillRateTrend }}%
        </div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value">{{ totalRecipes }}</div>
        <div class="stat-label">Recipes</div>
        <div class="stat-trend">Active</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value">{{ totalRawMaterials }}</div>
        <div class="stat-label">Materials</div>
        <div class="stat-trend">Total</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-value">{{ topProductOrder | number:'1.1-1' }}</div>
        <div class="stat-label">{{ topProductName }}</div>
        <div class="stat-trend">Top Product</div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Overview -->
      <div class="overview-section">
        <div class="section-header">
          <h2>Monthly Overview</h2>
          <div class="status">
            <span class="status-dot active"></span>
            <span>Current Period</span>
          </div>
        </div>
        
        <div class="overview-stats">
          <div class="overview-stat">
            <span class="stat-title">Total Batches</span>
            <span class="stat-number">{{ totalBatches | number:'1.1-1' }}</span>
          </div>
          
          <div class="overview-stat">
            <span class="stat-title">Reporting Stores</span>
            <span class="stat-number">{{ storesReporting }}/{{ totalStores }}</span>
          </div>
          
          <div class="overview-stat">
            <span class="stat-title">Active SKUs</span>
            <span class="stat-number">{{ activeSkus }}</span>
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="alerts-section">
        <div class="section-header">
          <h2>Alerts</h2>
          <span class="badge" *ngIf="lowFillRateProducts.length > 0">{{ lowFillRateProducts.length }}</span>
        </div>
        
        <div class="alerts-list" *ngIf="lowFillRateProducts.length > 0; else noAlerts">
          <div *ngFor="let product of lowFillRateProducts.slice(0, 3)" class="alert-item">
            <div class="alert-icon">!</div>
            <div class="alert-content">
              <div class="alert-title">{{ product.sku }}</div>
              <div class="alert-details">
                <span>{{ product.fillRate }}%</span>
                <span>•</span>
                <span>{{ product.store }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <ng-template #noAlerts>
          <div class="no-alerts">
            <span>✓</span>
            <span>No alerts</span>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Production Table -->
    <div class="table-section">
      <div class="section-header">
        <div class="table-header-left">
          <h2>Production Summary</h2>
          <div class="period-selector">
            <select class="month-select" [(ngModel)]="selectedMonth" (change)="onMonthChange()">
              <option *ngFor="let month of months" [value]="month.value">{{ month.label }}</option>
            </select>
            <select class="year-select" [(ngModel)]="selectedYear" (change)="onYearChange()">
              <option *ngFor="let year of years" [value]="year">{{ year }}</option>
            </select>
          </div>
        </div>
        
        <div class="table-header-right">
          <div class="search-box">
            <input 
              type="text" 
              placeholder="Search SKU or Material..." 
              [(ngModel)]="searchTerm"
              (ngModelChange)="filterMonthlySummary()"
            >
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </div>
          <button class="export-btn" (click)="exportToExcel()" [disabled]="monthlySummary.length === 0">
            Export
          </button>
        </div>
      </div>

      <div class="table-info">
        <span>
          {{ paginatedMonthlySummary.length }} of {{ filteredMonthlySummary.length }} items
          <span *ngIf="searchTerm" class="search-indicator">Filtered: "{{ searchTerm }}"</span>
        </span>
        <span *ngIf="monthlySummary.length > 0">
          Period: {{ currentMonthYear }}
        </span>
      </div>

      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>SKU / Material</th>
              <th class="text-right">UM</th>
              <th class="text-right">Raw Material</th>
              <th class="text-right">Output</th>
              <th class="text-right">Variance</th>
              <th class="text-right">Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="paginatedMonthlySummary.length === 0 && !isLoading">
              <td colspan="6" class="empty-state">
                {{ monthlySummary.length === 0 ? 'No data available for selected period' : 'No items match your search' }}
              </td>
            </tr>
            
            <tr *ngFor="let item of paginatedMonthlySummary">
              <td>
                <div class="sku-cell">
                  <span class="sku-type" [class]="getTypeClass(item.type)">{{ item.type.charAt(0) }}</span>
                  <div>
                    <div class="sku-code">{{ item.sku }}</div>
                    <div class="sku-category">{{ item.type }}</div>
                  </div>
                </div>
              </td>
              
              <td class="text-right">
                <span class="um">{{ item.um }}</span>
              </td>
              
              <td class="text-right">
                <span class="value">{{ item.actualRawMat | number:'1.3-3' }}</span>
              </td>
              
              <td class="text-right">
                <span class="value">{{ item.actualOutput | number:'1.3-3' }}</span>
              </td>
              
              <td class="text-right">
                <span class="variance" [class]="getVarianceClass(item.variance)">
                  {{ item.variance | number:'1.3-3' }}
                </span>
              </td>
              
              <td class="text-right">
                <span class="cost">₱{{ item.rawMatCost | number:'1.2-2' }}</span>
              </td>
            </tr>
          </tbody>
          
          <tfoot *ngIf="paginatedMonthlySummary.length > 0">
            <tr class="totals-row">
              <td colspan="2">Page Totals</td>
              <td class="text-right">{{ pageActualRawMat | number:'1.3-3' }}</td>
              <td class="text-right">{{ pageActualOutput | number:'1.3-3' }}</td>
              <td class="text-right" [class]="getVarianceClass(pageVariance)">
                {{ pageVariance | number:'1.3-3' }}
              </td>
              <td class="text-right">₱{{ pageRawMatCost | number:'1.2-2' }}</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination" *ngIf="filteredMonthlySummary.length > 0">
        <div class="pagination-info">
          {{ startIndex + 1 }}-{{ endIndex }} of {{ filteredMonthlySummary.length }}
        </div>
        
        <div class="pagination-controls">
          <button class="page-btn" (click)="previousPage()" [disabled]="currentPage === 1">
            ← Prev
          </button>
          <span class="page-number">{{ currentPage }} of {{ totalPages }}</span>
          <button class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
            Next →
          </button>
        </div>
      </div>
    </div>
  </div>
</div>