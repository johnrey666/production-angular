<div class="recipes">
  <!-- Loading Overlay - Matches Dashboard -->
  <div *ngIf="isLoading" class="dashboard-loading">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p class="loading-text">{{ loadingMessage || 'Loading recipes...' }}</p>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-content" [class.content-loading]="isLoading">
    <!-- Header - Matches Dashboard Style -->
    <header class="dashboard-header">
      <div class="header-left">
        <h1 class="dashboard-title">Recipes</h1>
        <div class="date-info">
          <span class="current-date">{{ currentDate }}</span>
          <span class="separator">‚Ä¢</span>
          <span class="period">Product formulations and ingredient standards</span>
        </div>
      </div>
      <button class="refresh-btn" (click)="refresh()" [disabled]="isLoading">
        <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 4v6h-6"></path>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        <span>{{ isLoading ? 'Refreshing...' : 'Refresh' }}</span>
      </button>
    </header>

    <!-- Snackbar -->
    <div class="snackbar-container" *ngIf="snackbarMessage">
      <div class="snackbar" [class]="'snackbar-' + snackbarType">
        <div class="snackbar-content">
          <div class="snackbar-icon">
            <svg *ngIf="snackbarType === 'success'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <svg *ngIf="snackbarType === 'error'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="15" y1="9" x2="9" y2="15"></line>
              <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
            <svg *ngIf="snackbarType === 'warning'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <svg *ngIf="snackbarType === 'info'" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          </div>
          <div class="snackbar-message">{{ snackbarMessage }}</div>
        </div>
        <button class="snackbar-close" (click)="hideSnackbar()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage && !isLoading" class="dashboard-error">
      <div class="error-content">
        <svg class="error-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <p class="error-message">{{ errorMessage }}</p>
        <button class="btn-secondary" (click)="refresh()">Retry</button>
      </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="!isLoading && !errorMessage">
      <!-- Controls Container - Matches Dashboard -->
      <div class="controls-container">
        <div class="controls-left">
          <div class="search-box">
            <input 
              type="text" 
              placeholder="Search recipes or raw materials..." 
              [(ngModel)]="searchQuery"
              (input)="onSearchInput()"
            >
            <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </div>
        </div>

        <div class="controls-right">
          <button class="action-btn primary" (click)="openAddRecipeModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Recipe
          </button>

          <label class="action-btn secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Import Excel
            <input type="file" accept=".xlsx,.xls" (change)="fileInputChange($event)" style="display:none;">
          </label>

          <button class="action-btn danger" (click)="deleteAllRecipes()" title="Delete All Recipes">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Delete All
          </button>
        </div>
      </div>

      <!-- Table Section - Enhanced to match dashboard -->
      <div class="table-section">
        <div class="table-info">
          <span>
            {{ recipes.length }} of {{ allRecipes.length }} recipes
            <span *ngIf="searchQuery" class="search-indicator">Search: "{{ searchQuery }}"</span>
          </span>
          <span *ngIf="allRecipes.length > 0">
            Page {{ currentPage }} of {{ totalPages }}
          </span>
        </div>

        <!-- Collapsible Recipe Cards -->
        <div class="recipes-grid" *ngIf="recipes.length > 0">
          <div class="recipe-card" *ngFor="let recipe of recipes" [class.expanded]="expandedRecipeId === recipe.id">
            <div class="recipe-card-header" (click)="toggleRecipeExpand(recipe.id)">
              <div class="recipe-header-content">
                <div class="recipe-title">
                  <h3>{{ recipe.name }}</h3>
                  <div class="recipe-meta">
                    <span class="recipe-id">ID: {{ recipe.id?.substring(0,8) }}...</span>
                    <span class="recipe-yield">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                      </svg>
                      {{ recipe.std_yield || 0 }} kg
                    </span>
                  </div>
                </div>
                <div class="recipe-stats">
                  <div class="stat-item">
                    <span class="stat-value">{{ getTotalRawMaterials(recipe) }}</span>
                    <span class="stat-label">Raw Materials</span>
                  </div>
                </div>
              </div>
              <div class="expand-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
            </div>

            <!-- Collapsible Content -->
            <div class="recipe-card-content" *ngIf="expandedRecipeId === recipe.id">
              <!-- Raw Materials Section - Combined SKUs and Premixes -->
              <div class="ingredient-section" *ngIf="getTotalRawMaterials(recipe) > 0">
                <div class="section-header">
                  <h4>Raw Materials ({{ getTotalRawMaterials(recipe) }})</h4>
                  <span class="section-badge">Ingredients</span>
                </div>
                <div class="ingredient-list">
                  <!-- Regular SKUs first -->
                  <div class="ingredient-item" *ngFor="let item of getCombinedMaterials(recipe)">
                    <div class="ingredient-name">
                      {{ item.name }}
                      <span *ngIf="item.type === 'premix'" class="premix-tag">[pre-mix]</span>
                    </div>
                    <div class="ingredient-quantities">
                      <div class="quantity-item">
                        <span class="quantity-label">1B</span>
                        <span class="quantity-value">{{ item.quantity1b || 0 | number:'1.3-3' }}</span>
                      </div>
                      <div class="quantity-item">
                        <span class="quantity-label">¬ΩB</span>
                        <span class="quantity-value">{{ item.quantityhalfb || 0 | number:'1.3-3' }}</span>
                      </div>
                      <div class="quantity-item">
                        <span class="quantity-label">¬ºB</span>
                        <span class="quantity-value">{{ item.quantityquarterb || 0 | number:'1.3-3' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Empty state if no ingredients -->
              <div *ngIf="getTotalRawMaterials(recipe) === 0" class="empty-ingredients">
                <p>No raw materials added yet. Add ingredients to this recipe.</p>
              </div>

              <!-- Action Buttons -->
              <div class="recipe-actions">
                <button class="btn-action view" (click)="viewRecipeDetails(recipe)" title="View Full Details">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  View Details
                </button>
                <button class="btn-action edit" (click)="openEditRecipeModal(recipe)" title="Edit Recipe">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                  Edit
                </button>
                <button class="btn-action delete" (click)="deleteRecipe(recipe.id, recipe.name)" title="Delete Recipe">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                  Delete
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State - Match Dashboard -->
        <div *ngIf="recipes.length === 0" class="empty-state">
          <div class="empty-content">
            <div class="empty-icon">üìã</div>
            <h3>No Recipes Found</h3>
            <p>Try adjusting your search or add a new recipe</p>
            <button class="btn-primary" (click)="openAddRecipeModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Add Your First Recipe
            </button>
          </div>
        </div>

        <!-- Pagination - Match Dashboard -->
        <div class="pagination" *ngIf="allRecipes.length > 0">
          <div class="pagination-info">
            {{ startIndex + 1 }}-{{ endIndex }} of {{ allRecipes.length }}
          </div>
          
          <div class="pagination-controls">
            <button class="page-btn" (click)="previousPage()" [disabled]="currentPage === 1">
              ‚Üê Prev
            </button>
            <span class="page-number">{{ currentPage }} of {{ totalPages }}</span>
            <button class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
              Next ‚Üí
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View Details Modal - Enhanced -->
  <div *ngIf="showDetailsModal && selectedRecipe" class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">{{ selectedRecipe.name }}</h2>
        <button class="modal-close" (click)="closeDetailsModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>STD Yield:</label>
          <div class="form-input-static">{{ selectedRecipe.std_yield || 0 }} kg</div>
        </div>

        <div *ngIf="getTotalRawMaterials(selectedRecipe) > 0" class="section">
          <h4>Raw Materials ({{ getTotalRawMaterials(selectedRecipe) }})</h4>
          <table class="form-table">
            <thead>
              <tr>
                <th>Name</th>
                <th class="text-right">1B</th>
                <th class="text-right">1/2B</th>
                <th class="text-right">1/4B</th>
                <th>Type</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of getCombinedMaterials(selectedRecipe)">
                <td>{{ item.name }}</td>
                <td class="text-right">{{ item.quantity1b || 0 | number:'1.3-3' }}</td>
                <td class="text-right">{{ item.quantityhalfb || 0 | number:'1.3-3' }}</td>
                <td class="text-right">{{ item.quantityquarterb || 0 | number:'1.3-3' }}</td>
                <td>
                  <span *ngIf="item.type === 'premix'" class="premix-badge">pre-mix</span>
                  <span *ngIf="item.type === 'sku'" class="sku-badge">standard</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeDetailsModal()">Close</button>
        <button class="btn-primary" (click)="openEditRecipeModal(selectedRecipe)">Edit Recipe</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Recipe Modal - Enhanced -->
  <div *ngIf="showRecipeModal" class="modal-overlay" (click)="closeRecipeModal()">
    <div class="modal-container" (click)="$event.stopPropagation()" style="max-width: 700px; max-height: 85vh;">
      <div class="modal-header">
        <h2 class="modal-title">{{ editingRecipe.id ? 'Edit' : 'Add' }} Recipe</h2>
        <button class="modal-close" (click)="closeRecipeModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <label>Product Name *</label>
            <input type="text" [(ngModel)]="editingRecipe.name" class="form-input" placeholder="Enter recipe name" required>
          </div>
          <div class="form-group">
            <label>STD Yield (kg) *</label>
            <input type="number" [(ngModel)]="editingRecipe.stdYield" class="form-input" min="0" step="0.1" required>
          </div>
        </div>

        <!-- Raw Materials - Combined -->
        <div class="section">
          <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4>Raw Materials ({{ editingRecipe.rawMaterials.length }})</h4>
            <div style="display: flex; gap: 0.5rem;">
              <button type="button" class="btn-secondary" (click)="addRawMaterial('sku')">Add Standard</button>
              <button type="button" class="btn-secondary" (click)="addRawMaterial('premix')">Add Pre-mix</button>
            </div>
          </div>
          <div class="table-container" *ngIf="editingRecipe.rawMaterials.length > 0">
            <table class="form-table">
              <thead>
                <tr>
                  <th style="width: 180px;">Name / Type</th>
                  <th class="text-right">1B</th>
                  <th class="text-right">1/2B</th>
                  <th class="text-right">1/4B</th>
                  <th style="width: 50px;">Action</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of editingRecipe.rawMaterials; let i = index">
                  <td>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                      <input [(ngModel)]="item.name" class="form-input small" 
                             [placeholder]="item.type === 'premix' ? 'Enter raw material name' : 'Enter raw material name'">
                      <select [(ngModel)]="item.type" class="form-select small" style="font-size: 11px; padding: 4px;">
                        <option value="sku">Standard</option>
                        <option value="premix">Pre-mix</option>
                      </select>
                    </div>
                  </td>
                  <td class="text-right">
                    <input type="number" [(ngModel)]="item.quantity1b" min="0" step="0.001" 
                           class="form-input small text-right" style="width: 70px;">
                  </td>
                  <td class="text-right">
                    <input type="number" [(ngModel)]="item.quantityhalfb" min="0" step="0.001" 
                           class="form-input small text-right" style="width: 70px;">
                  </td>
                  <td class="text-right">
                    <input type="number" [(ngModel)]="item.quantityquarterb" min="0" step="0.001" 
                           class="form-input small text-right" style="width: 70px;">
                  </td>
                  <td>
                    <button class="btn-icon-danger small" (click)="removeRawMaterial(i)" title="Remove">√ó</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <p *ngIf="editingRecipe.rawMaterials.length === 0" class="empty-state">No raw materials added yet</p>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closeRecipeModal()">Cancel</button>
        <button type="button" class="btn-primary" (click)="saveRecipe()" [disabled]="!isRecipeValid()">
          {{ editingRecipe.id ? 'Update' : 'Save' }} Recipe
        </button>
      </div>
    </div>
  </div>
</div>